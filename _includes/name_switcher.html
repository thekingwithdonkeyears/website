<div class="name-switcher-container">
    <details>
        <summary class="name-switcher-summary">ğŸ› ï¸ è§’è‰²åå­—æ›¿æ› (é»æ“Šå±•é–‹)</summary>
        <div style="margin-top: 10px;">
            <p class="name-switcher-desc">è¼¸å…¥æ–°åå­—ä¾†æ›¿æ›æ–‡ç« ä¸­çš„ä¸»è§’åå­—ã€‚</p>

            <!-- Logic to determine default names based on tags -->
            {% assign default_name_1 = "{p1}" %}
            {% assign default_name_2 = "{p2}" %}


            <div class="name-switcher-row">
                <div class="name-switcher-group">
                    <label class="name-switcher-label">åŸå 1</label>
                    <input type="text" id="orig-name-1" value="{{ default_name_1 }}" placeholder="ä¾‹å¦‚ï¼šæ¹Šå´"
                        class="name-switcher-input" readonly>
                </div>
                <div class="name-switcher-arrow">â¡ï¸</div>
                <div class="name-switcher-group">
                    <label class="name-switcher-label">æ–°å 1</label>
                    <input type="text" id="new-name-1" placeholder="ä¸»è§’1çš„åå­—" class="name-switcher-input">
                </div>
            </div>

            <div class="name-switcher-row">
                <div class="name-switcher-group">
                    <label class="name-switcher-label">åŸå 2</label>
                    <input type="text" id="orig-name-2" value="{{ default_name_2 }}" placeholder="ä¾‹å¦‚ï¼šå‘¨å­ç‘œ"
                        class="name-switcher-input" readonly>
                </div>
                <div class="name-switcher-arrow">â¡ï¸</div>
                <div class="name-switcher-group">
                    <label class="name-switcher-label">æ–°å 2</label>
                    <input type="text" id="new-name-2" placeholder="ä¸»è§’2çš„åå­—" class="name-switcher-input">
                </div>
            </div>

            <div class="name-switcher-actions">
                <button id="btn-replace-names" class="name-switcher-btn">é–‹å§‹æ›¿æ›</button>
                <button id="id-download-story" class="name-switcher-btn">ä¸‹è¼‰æ–‡ç«  (.txt)</button>
                <button id="btn-reset-names" class="name-switcher-btn">å¾©åŸ</button>
            </div>
        </div>
    </details>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        document.getElementById('btn-replace-names').addEventListener('click', function () {
            const contentArea = document.getElementById('story-content');

            if (!contentArea) {
                alert('è«‹å…ˆè§£é–æ–‡ç« å…§å®¹ï¼Œæ‰èƒ½ä½¿ç”¨æ”¹ååŠŸèƒ½ï¼');
                return;
            }

            // Store original content to allow reset if not already stored
            // Note: We need a way to store the *original* unlocked content. 
            // Since contentArea is dynamic, we can store it on the element itself or a variable if we assume single instance.
            if (!contentArea.dataset.originalHtml) {
                contentArea.dataset.originalHtml = contentArea.innerHTML;
            }

            // ... rest of logic uses contentArea ...
            const orig1 = document.getElementById('orig-name-1').value.trim();
            const new1 = document.getElementById('new-name-1').value.trim();
            const orig2 = document.getElementById('orig-name-2').value.trim();
            const new2 = document.getElementById('new-name-2').value.trim();

            if ((!orig1 || !new1) && (!orig2 || !new2)) {
                alert('è«‹è‡³å°‘è¼¸å…¥ä¸€çµ„å®Œæ•´çš„åå­—ï¼');
                return;
            }

            // Restore original first
            contentArea.innerHTML = contentArea.dataset.originalHtml;

            let html = contentArea.innerHTML;

            if (orig1 && new1) {
                // Create regex with global flag
                const regex1 = new RegExp(orig1, 'g');
                html = html.replace(regex1, `<span class="replaced-name">${new1}</span>`);
            }

            if (orig2 && new2) {
                const regex2 = new RegExp(orig2, 'g');
                html = html.replace(regex2, `<span class="replaced-name">${new2}</span>`);
            }

            contentArea.innerHTML = html;

            // Close the details panel to let user read
            document.querySelector('.name-switcher-container details').removeAttribute('open');
        });

        document.getElementById('btn-reset-names').addEventListener('click', function () {
            const contentArea = document.getElementById('story-content');
            if (contentArea && contentArea.dataset.originalHtml) {
                contentArea.innerHTML = contentArea.dataset.originalHtml;
            }
        });

        document.getElementById('id-download-story').addEventListener('click', function () {
            const contentArea = document.getElementById('story-content');
            if (!contentArea) {
                alert('è«‹å…ˆè§£é–æ–‡ç« å…§å®¹ï¼Œæ‰èƒ½ä¸‹è¼‰ï¼');
                return;
            }

            // Get text and clean it up a bit
            let text = contentArea.innerText;

            // Basic cleanup: remove excessive blank lines often caused by innerText on HTML
            text = text.replace(/\n\s*\n/g, '\n\n').trim();

            const blob = new Blob([text], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');

            // Attempt to get a title for the filename
            const storyTitle = document.querySelector('h1')?.innerText || 'my_story';
            const fileName = `${storyTitle.replace(/[\\/:*?"<>|]/g, '_')}.txt`;

            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });
    });
</script>