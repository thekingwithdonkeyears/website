<!DOCTYPE html>
<html lang="zh-TW">

<head>
    {% include google-analytics.html %}
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ page.title }}</title>
    <link rel="icon" type="image/png" href="{{ '/assets/images/favicon.png' | relative_url }}">
    <link rel="stylesheet" href="{{ '/assets/css/style.css' | relative_url }}">
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4087964762824382"
        crossorigin="anonymous"></script>
    <style>
        /* Role Play Specific Styles */
        .role-inputs {
            margin-bottom: 20px;
            padding: 15px;
            background: var(--toc-bg);
            /* Use theme variable */
            border: 1px solid var(--border-color);
            border-radius: 5px;
            color: var(--text-color);
        }

        .role-input-group {
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            /* Allow wrapping on small screens */
            gap: 10px;
        }

        .role-input-group label {
            display: inline-block;
            font-weight: bold;
            color: var(--text-color);
        }

        .role-input-group input {
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 3px;
            background-color: var(--content-bg);
            color: var(--text-color);
            width: 150px;
            /* Slightly wider */
        }

        .role-header {
            font-weight: bold;
            margin-bottom: 10px;
            margin-top: 15px;
            color: var(--text-color);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 5px;
        }

        .preview-text {
            background-color: var(--category-bg);
            padding: 15px;
            border-left: 5px solid var(--link-color);
            margin-bottom: 20px;
            font-style: italic;
            color: var(--text-color);
        }

        /* Use global button styles, just add margin if needed */
        .buttons {
            /* Inherits global button styles, just ensuring specific overrides if any */
            margin-left: 10px;
        }
    </style>
</head>

<body>

    {% include navbar.html %} <!-- Insert Navbar -->

    <div class="container">
        <main class="content">

            <!-- AdSense: Top -->
            <div class="google-ad-top" style="margin: 20px 0;">
                {% include google-ad-post-top.html %}
            </div>


            {% if page.preview %}
            <div class="preview-text">
                {{ page.preview | markdownify }}
            </div>
            {% endif %}

            <section id="main-section" style="display: none;">
                <div id="role-inputs-container" class="role-inputs"></div>

                <div id="content-area">
                    {{ content }}
                </div>
            </section>

            <section id="password-section" style="display: none;">
                <div class="role-inputs">
                    <h3>Password Required</h3>
                    <p>Please enter the password to view this content.</p>
                    <div class="role-input-group">
                        <input type="password" id="password-input" placeholder="Enter password" style="width: 200px;">
                        <button id="password-submit" class="buttons">Submit</button>
                    </div>
                    <p id="password-error" style="color: red; display: none;">Incorrect password.</p>
                    {% if page.hint %}
                    <p style="margin-top: 10px; font-size: 0.9em;">
                        <a href="{{ page.hint }}" target="_blank">Get a hint / Find password</a>
                    </p>
                    {% endif %}
                </div>
            </section>

            <!--{% include comments.html %}-->

            <!-- AdSense: Bottom -->
            <div class="google-ad-bottom" style="margin: 20px 0;">
                {% include google-ad-post-bottom.html %}
            </div>

            <!-- 上下篇連結開始 -->
            {% comment %}
            先收集同一分類的文章，再排序，並找出當前文章的位置
            {% endcomment %}
            {% assign current_category = nil %}
            {% for cat in page.categories %}
            {% if cat != "同人" and cat != "TWICE" %}
            {% assign current_category = cat %}
            {% break %}
            {% endif %}
            {% endfor %}

            {% if current_category == nil %}
            {% assign current_category = page.categories | last %}
            {% endif %}

            {% assign related_posts = site.posts | where_exp:"post", "post.categories contains current_category" | sort:
            "date" %}
            {% for post in related_posts %}
            {% if post.url == page.url %}
            {% assign index = forloop.index0 %}
            {% endif %}
            {% endfor %}

            <nav class="post-navigation">

                {% if index and index > 0 %}
                {% assign prev_index = index | minus: 1 %}
                {% assign prev_post = related_posts[prev_index] %}
                <a class="prev-post" href="{{ prev_post.url | prepend: site.baseurl }}">
                    {{ prev_post.title }}
                </a>
                {% else %}
                <!-- Spacer if no prev post -->
                <div style="flex:1;"></div>
                {% endif %}

                {% assign last_index = related_posts.size | minus: 1 %}
                {% if index and index < last_index %} {% assign next_index=index | plus: 1 %} {% assign
                    next_post=related_posts[next_index] %} <a class="next-post"
                    href="{{ next_post.url | prepend: site.baseurl }}">
                    {{ next_post.title }}
                    </a>
                    {% else %}
                    <!-- Spacer if no next post -->
                    <div style="flex:1;"></div>
                    {% endif %}
            </nav>
            <p>留言要作者手動審核後才會發佈，如果沒即時出現是正常現象，請耐心等候</p>
            <!-- 上下篇連結結束 -->
        </main>
    </div>

    <footer>
        <p>&copy; {{ site.time | date: "%Y" }} 國王和她的驢耳朵. All rights reserved.</p>
    </footer>

    <script>
        (function () {
            const roleCount = {{ page.num_roles | default: page.roles | default: 0
        }};
        const pagePassword = "{{ page.password }}";

        const mainSection = document.getElementById('main-section');
        const passwordSection = document.getElementById('password-section');
        const passwordInput = document.getElementById('password-input');
        const passwordSubmit = document.getElementById('password-submit');
        const passwordError = document.getElementById('password-error');
        const container = document.getElementById('role-inputs-container');
        const contentArea = document.getElementById('content-area');

        // Defaults from front matter
        const defaultRoles = {};
        {% if page.num_roles %}
        {% for i in (1..page.num_roles) %}
        defaultRoles[{{ i }}] = { };
        {% assign key_last = "default_p" | append: i | append: "_last" %}
        {% assign key_first = "default_p" | append: i | append: "_first" %}

        {% if page[key_last] %}
        defaultRoles[{{ i }}].last = "{{ page[key_last] }}";
        {% endif %}

        {% if page[key_first] %}
        defaultRoles[{{ i }}].first = "{{ page[key_first] }}";
        {% endif %}
        {% endfor %}
        {% endif %}

        // Helper: Check Password
        function checkPassword() {
            const urlParams = new URLSearchParams(window.location.search);
            const pwdParam = urlParams.get('pwd');
            const directParam = window.location.search.substring(1);

            if (!pagePassword) return true;

            if (pwdParam === pagePassword) return true;
            if (directParam === pagePassword) return true;

            if (sessionStorage.getItem('unlocked_' + window.location.pathname) === 'true') return true;

            return false;
        }

        function unlockContent() {
            mainSection.style.display = 'block';
            passwordSection.style.display = 'none';
            sessionStorage.setItem('unlocked_' + window.location.pathname, 'true');
            initRoles();
        }

        function showLock() {
            mainSection.style.display = 'none';
            passwordSection.style.display = 'block';
        }

        // --- Role Logic ---
        const originalContent = contentArea.innerHTML;

        const getSavedLast = (index) => localStorage.getItem('role_' + index + '_last') || (defaultRoles[index] ? defaultRoles[index].last : '') || '';
        const getSavedFirst = (index) => localStorage.getItem('role_' + index + '_first') || (defaultRoles[index] ? defaultRoles[index].first : '') || '';

        const setSavedLast = (index, value) => localStorage.setItem('role_' + index + '_last', value);
        const setSavedFirst = (index, value) => localStorage.setItem('role_' + index + '_first', value);

        function updateContent() {
            let newContent = originalContent;
            for (let i = 1; i <= roleCount; i++) {
                const inputLast = document.getElementById('role-input-last-' + i);
                const inputFirst = document.getElementById('role-input-first-' + i);

                const lastName = inputLast ? inputLast.value.trim() : getSavedLast(i);
                const firstName = inputFirst ? inputFirst.value.trim() : getSavedFirst(i);
                const fullName = lastName + firstName;

                // Sub replacements
                // {pX_last}
                if (lastName) {
                    newContent = newContent.replace(new RegExp('{p' + i + '_last}', 'g'), lastName);
                }
                // {pX_first}
                if (firstName) {
                    newContent = newContent.replace(new RegExp('{p' + i + '_first}', 'g'), firstName);
                }
                // {pX} - Full Name (Concat)
                if (fullName) {
                    newContent = newContent.replace(new RegExp('{p' + i + '}', 'g'), fullName);
                }
            }
            contentArea.innerHTML = newContent;
        }

        function initRoles() {
            if (roleCount <= 0) return;

            container.innerHTML = '';

            if (roleCount > 0) {
                const header = document.createElement('h3');
                header.textContent = '角色設定';
                container.appendChild(header);
            }

            for (let i = 1; i <= roleCount; i++) {
                const wrapper = document.createElement('div');

                const header = document.createElement('div');
                header.className = 'role-header';
                header.textContent = 'Role ' + i;
                wrapper.appendChild(header);

                const group = document.createElement('div');
                group.className = 'role-input-group';

                // Last Name
                const labelLast = document.createElement('label');
                labelLast.textContent = '姓:';
                labelLast.htmlFor = 'role-input-last-' + i;

                const inputLast = document.createElement('input');
                inputLast.type = 'text';
                inputLast.id = 'role-input-last-' + i;
                inputLast.placeholder = '姓';
                inputLast.value = getSavedLast(i);
                inputLast.addEventListener('input', (e) => {
                    setSavedLast(i, e.target.value);
                    updateContent();
                });

                // First Name
                const labelFirst = document.createElement('label');
                labelFirst.textContent = '名:';
                labelFirst.htmlFor = 'role-input-first-' + i;

                const inputFirst = document.createElement('input');
                inputFirst.type = 'text';
                inputFirst.id = 'role-input-first-' + i;
                inputFirst.placeholder = '名';
                inputFirst.value = getSavedFirst(i);
                inputFirst.addEventListener('input', (e) => {
                    setSavedFirst(i, e.target.value);
                    updateContent();
                });

                group.appendChild(labelLast);
                group.appendChild(inputLast);

                group.appendChild(labelFirst);
                group.appendChild(inputFirst);

                wrapper.appendChild(group);
                container.appendChild(wrapper);
            }
            updateContent();
        }

        // --- Init ---
        if (checkPassword()) {
            unlockContent();
        } else {
            showLock();
        }

        const submitBtn = document.getElementById('password-submit');
        if (submitBtn) {
            submitBtn.addEventListener('click', () => {
                if (passwordInput.value === pagePassword) {
                    unlockContent();
                } else {
                    passwordError.style.display = 'block';
                }
            });
        }

        if (passwordInput) {
            passwordInput.addEventListener('keyup', (e) => {
                if (e.key === 'Enter') document.getElementById('password-submit').click();
            });
        }

      }) ();
    </script>
    {% if site.enable_age_verification %}
    {% include age_verification.html %}
    {% endif %}
</body>

</html>